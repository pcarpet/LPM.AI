<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAFe LPM - Planification Capacitaire</title>
    <!-- Tailwind CSS pour le styling rapide et propre -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .input-bare { border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px; width: 100%; text-align: center; }
        .input-bare:focus { outline: 2px solid #3b82f6; border-color: transparent; }
        
        /* Table Sticky Header */
        .table-container { max-height: 500px; overflow-y: auto; }
        thead th { position: sticky; top: 0; background: #f9fafb; z-index: 10; }

        /* Drag & Drop Styles */
        .draggable-row { cursor: grab; }
        .draggable-row:active { cursor: grabbing; }
        .dragging { opacity: 0.5; background-color: #e0e7ff; } /* Light indigo */
        .drag-over { border-top: 2px solid #3b82f6; } /* Blue line indicator */
    </style>
</head>
<body class="text-gray-800 relative">

    <!-- Header -->
    <nav class="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-chart-pie text-2xl text-blue-400"></i>
                <h1 class="text-xl font-bold">LPM Dashboard <span class="text-sm font-normal text-gray-400">| Lean Portfolio Management</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="autoPlanPortfolio()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-4 py-2 rounded-lg font-bold shadow-md transition-all flex items-center gap-2 text-sm border border-green-400">
                    <i class="fa-solid fa-robot"></i> Auto-Planifier (selon Priorité)
                </button>
                <div class="text-sm bg-slate-700 px-3 py-1 rounded hidden md:block">
                    <span id="global-status">Mode Manuel</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- ZONE 1: BACKLOG DES EPICS -->
        <div class="lg:col-span-12 card p-5 border-t-4 border-blue-500">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h2 class="text-lg font-bold"><i class="fa-solid fa-list-check mr-2"></i>Portfolio Backlog</h2>
                    <p class="text-sm text-gray-500">Glissez-déposez les lignes pour changer la priorité (Haut = Prio 1). L'auto-planification respectera cet ordre.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetData()" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-gray-700">
                        <i class="fa-solid fa-rotate-right mr-1"></i> Reset Data
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs uppercase text-gray-500 border-b">
                            <th class="p-3 w-10 text-center"></th> <!-- Handle -->
                            <th class="p-3 w-16 text-center">Prio</th>
                            <th class="p-3 w-3/12">Epic Name</th>
                            <th class="p-3 w-20 text-center">Est. (J/H)</th>
                            <th class="p-3 w-24 text-center">Start PI</th>
                            <th class="p-3 w-16 text-center text-blue-600">VS1 %</th>
                            <th class="p-3 w-16 text-center text-green-600">VS2 %</th>
                            <th class="p-3 w-16 text-center text-amber-600">VS3 %</th>
                            <th class="p-3 w-16 text-center text-purple-600">VS4 %</th>
                            <th class="p-3 w-16 text-center">Total %</th>
                        </tr>
                    </thead>
                    <tbody id="epics-table-body" class="text-sm text-gray-700">
                        <!-- Généré par JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ZONE 2: CONFIGURATION (Value Streams) -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Value Streams Config -->
            <div class="card p-5">
                <h2 class="text-lg font-bold mb-4"><i class="fa-solid fa-water mr-2"></i>Value Streams (Capacité)</h2>
                <p class="text-xs text-gray-500 mb-3">Définissez la capacité (vélocité moyenne en J/H) par PI pour chaque Value Stream.</p>
                
                <div id="vs-config-container" class="space-y-4">
                    <!-- Généré par JS -->
                </div>
            </div>

             <!-- Résumé Portfolio -->
             <div class="space-y-4">
                <div class="card p-4 flex items-center justify-between border-l-4 border-indigo-500">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Epics dans le Funnel</div>
                        <div class="text-2xl font-bold text-indigo-600" id="totalEpicsCount">0</div>
                    </div>
                    <i class="fa-solid fa-filter text-indigo-200 text-3xl"></i>
                </div>
                <div class="card p-4 flex items-center justify-between border-l-4 border-purple-500">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Total Jours/Homme</div>
                        <div class="text-2xl font-bold text-purple-600" id="totalPointsCount">0</div>
                    </div>
                    <i class="fa-solid fa-clock text-purple-200 text-3xl"></i>
                </div>
                <div class="card p-4 flex items-center justify-between border-l-4 border-amber-500">
                    <div>
                        <div class="text-xs text-gray-500 uppercase">Charge Globale</div>
                        <div class="text-2xl font-bold text-amber-600" id="avgCompletion">0%</div>
                    </div>
                    <i class="fa-solid fa-battery-half text-amber-200 text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- ZONE 3: VISUALISATION (Charts - Vue Annuelle) -->
        <div class="lg:col-span-8 space-y-6">
            <div class="card p-5">
                <h2 class="text-lg font-bold mb-4"><i class="fa-solid fa-scale-balanced mr-2"></i>Charge vs Capacité (Vue Annuelle par Value Stream)</h2>
                
                <!-- Container pour les 4 graphiques générés dynamiquement -->
                <div id="charts-container" class="grid grid-cols-1 gap-8">
                    <!-- Injection JS -->
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. DATA INITIALIZATION ---
        
        // Configuration initiale des Value Streams
        const initialValueStreams = [
            { id: 'vs1', name: 'Consumer Banking', capacityPerPI: 500, color: 'rgba(59, 130, 246, 0.7)' }, // Blue
            { id: 'vs2', name: 'Loans & Credit',   capacityPerPI: 450, color: 'rgba(16, 185, 129, 0.7)' }, // Green
            { id: 'vs3', name: 'Investment App',   capacityPerPI: 300, color: 'rgba(245, 158, 11, 0.7)' }, // Amber
            { id: 'vs4', name: 'Corporate Infra',  capacityPerPI: 600, color: 'rgba(139, 92, 246, 0.7)' }  // Purple
        ];

        let valueStreams = JSON.parse(JSON.stringify(initialValueStreams));

        // Génération de 20 Epics par défaut
        function generateEpics() {
            const epics = [];
            const prefixes = ["Cloud Migration", "Mobile App v2", "AI Chatbot", "Compliance 2026", "Data Lake", "CRM Upgrade", "Security Audit", "API Gateway", "UX Redesign", "Payment Gateway"];
            
            // Calcul cible pour ~130% de charge globale
            
            for(let i=1; i<=20; i++) {
                let splitType = i % 4; 
                let v1=0, v2=0, v3=0, v4=0;
                
                if(splitType === 0) { v1=100; }
                else if(splitType === 1) { v2=100; }
                else if(splitType === 2) { v1=50; v2=50; }
                else { v3=30; v4=70; }

                const estimate = (Math.floor(Math.random() * 37) + 30) * 10;

                epics.push({
                    id: i,
                    priority: i, 
                    name: `Epic ${i}: ${prefixes[i%prefixes.length]}`,
                    estimate: estimate, 
                    startPI: 1, 
                    vs1: v1,
                    vs2: v2,
                    vs3: v3,
                    vs4: v4
                });
            }
            return epics;
        }

        let epics = generateEpics();
        let chartInstances = [];
        let dragSrcIndex = null; // Pour le Drag & Drop

        // --- 2. CORE LOGIC ---

        function updateDashboard() {
            // Recalcule les priorités basées sur l'index avant le rendu
            epics.forEach((epic, index) => {
                epic.priority = index + 1;
            });
            
            renderVSInputs();
            renderEpicsTable();
            calculateAndRenderCharts();
        }

        // --- DRAG & DROP FUNCTIONS ---
        
        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcIndex = parseInt(this.getAttribute('data-index'));
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // Necessary. Allows us to drop.
            }
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation(); // Stops some browsers from redirecting.
            }

            const targetIndex = parseInt(this.getAttribute('data-index'));

            if (dragSrcIndex !== null && dragSrcIndex !== targetIndex) {
                // Déplacer l'élément dans le tableau
                const itemToMove = epics[dragSrcIndex];
                epics.splice(dragSrcIndex, 1); // Retirer de l'ancienne position
                epics.splice(targetIndex, 0, itemToMove); // Insérer à la nouvelle position
                
                updateDashboard(); // Re-render
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.draggable-row').forEach(row => {
                row.classList.remove('drag-over');
            });
        }

        // --- ALGORITHME D'AUTO-PLANIFICATION ---
        function autoPlanPortfolio() {
            // La liste est déjà triée par priorité visuelle (index)
            // On reset les matrices de capacité
            let availableCapacity = valueStreams.map(vs => [vs.capacityPerPI, vs.capacityPerPI, vs.capacityPerPI, vs.capacityPerPI]);

            epics.forEach(epic => {
                let assigned = false;
                
                let loadVS1 = epic.estimate * (epic.vs1 / 100);
                let loadVS2 = epic.estimate * (epic.vs2 / 100);
                let loadVS3 = epic.estimate * (epic.vs3 / 100);
                let loadVS4 = epic.estimate * (epic.vs4 / 100);
                
                for (let pi = 0; pi < 4; pi++) {
                    if (
                        availableCapacity[0][pi] >= loadVS1 &&
                        availableCapacity[1][pi] >= loadVS2 &&
                        availableCapacity[2][pi] >= loadVS3 &&
                        availableCapacity[3][pi] >= loadVS4
                    ) {
                        epic.startPI = pi + 1;
                        
                        availableCapacity[0][pi] -= loadVS1;
                        availableCapacity[1][pi] -= loadVS2;
                        availableCapacity[2][pi] -= loadVS3;
                        availableCapacity[3][pi] -= loadVS4;
                        
                        assigned = true;
                        break;
                    }
                }

                if (!assigned) {
                    epic.startPI = "Backlog";
                }
            });

            document.getElementById('global-status').innerText = "Auto-Planification Terminée";
            document.getElementById('global-status').className = "text-green-400 font-bold bg-slate-700 px-3 py-1 rounded";
            updateDashboard();
        }

        // --- 3. DOM RENDERING ---

        function renderVSInputs() {
            const container = document.getElementById('vs-config-container');
            container.innerHTML = '';

            valueStreams.forEach((vs, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 bg-gray-50 rounded border hover:border-blue-300 transition-colors";
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${vs.color}"></div>
                        <span class="font-semibold text-sm w-32 truncate">${vs.name}</span>
                    </div>
                    <div class="flex flex-col items-end">
                        <label class="text-[10px] text-gray-500 uppercase">Capacité (J/H)</label>
                        <input type="number" 
                               value="${vs.capacityPerPI}" 
                               onchange="updateVSCapacity(${index}, this.value)"
                               class="text-right w-20 font-bold bg-white border rounded px-1 text-sm focus:ring-2 focus:ring-blue-200 focus:outline-none">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderEpicsTable() {
            const tbody = document.getElementById('epics-table-body');
            tbody.innerHTML = '';
            
            let totalPoints = 0;

            epics.forEach((epic, index) => {
                totalPoints += parseInt(epic.estimate);
                const totalSplit = epic.vs1 + epic.vs2 + epic.vs3 + epic.vs4;
                const splitColor = totalSplit === 100 ? 'text-green-600' : 'text-red-500 font-bold';
                
                let piDisplay = '';
                if(epic.startPI === "Backlog") {
                    piDisplay = `<span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">Hors Capa</span>`;
                } else {
                    piDisplay = `
                        <select class="input-bare" onchange="updateEpic(${index}, 'startPI', this.value)">
                            <option value="1" ${epic.startPI == 1 ? 'selected' : ''}>PI 1</option>
                            <option value="2" ${epic.startPI == 2 ? 'selected' : ''}>PI 2</option>
                            <option value="3" ${epic.startPI == 3 ? 'selected' : ''}>PI 3</option>
                            <option value="4" ${epic.startPI == 4 ? 'selected' : ''}>PI 4</option>
                        </select>
                    `;
                }

                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-blue-50 transition-colors draggable-row";
                tr.setAttribute('draggable', 'true');
                tr.setAttribute('data-index', index);
                
                // Add Drag Events
                tr.addEventListener('dragstart', handleDragStart);
                tr.addEventListener('dragover', handleDragOver);
                tr.addEventListener('dragleave', handleDragLeave);
                tr.addEventListener('drop', handleDrop);
                tr.addEventListener('dragend', handleDragEnd);

                tr.innerHTML = `
                    <td class="p-2 text-center text-gray-400 cursor-grab"><i class="fa-solid fa-grip-vertical"></i></td>
                    <td class="p-2 text-center">
                        <span class="font-bold text-slate-700 w-12 mx-auto block bg-slate-100 rounded py-1">${index + 1}</span>
                    </td>
                    <td class="p-2">
                        <input type="text" value="${epic.name}" class="input-bare text-left font-medium" onchange="updateEpic(${index}, 'name', this.value)">
                    </td>
                    <td class="p-2">
                        <input type="number" value="${epic.estimate}" class="input-bare font-mono" onchange="updateEpic(${index}, 'estimate', this.value)">
                    </td>
                    <td class="p-2 text-center">
                        ${piDisplay}
                    </td>
                    <td class="p-2"><input type="number" value="${epic.vs1}" class="input-bare text-blue-600 font-semibold" onchange="updateEpic(${index}, 'vs1', this.value)"></td>
                    <td class="p-2"><input type="number" value="${epic.vs2}" class="input-bare text-green-600 font-semibold" onchange="updateEpic(${index}, 'vs2', this.value)"></td>
                    <td class="p-2"><input type="number" value="${epic.vs3}" class="input-bare text-amber-600 font-semibold" onchange="updateEpic(${index}, 'vs3', this.value)"></td>
                    <td class="p-2"><input type="number" value="${epic.vs4}" class="input-bare text-purple-600 font-semibold" onchange="updateEpic(${index}, 'vs4', this.value)"></td>
                    <td class="p-2 text-center ${splitColor}">${totalSplit}%</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('totalEpicsCount').innerText = epics.length;
            document.getElementById('totalPointsCount').innerText = totalPoints;
        }

        // --- 4. UPDATES & CHARTING ---

        function updateVSCapacity(index, value) {
            valueStreams[index].capacityPerPI = parseInt(value) || 0;
            calculateAndRenderCharts();
        }

        function updateEpic(index, field, value) {
            if (field === 'name') {
                epics[index][field] = value;
            } else if (field === 'startPI') {
                epics[index][field] = parseInt(value);
            } else {
                epics[index][field] = parseInt(value) || 0;
            }
            // Pas de updateDashboard complet ici pour éviter de perdre le focus si on tape, 
            // sauf que pour priority (qui n'existe plus en edit) c'était nécessaire. 
            // On peut re-render light ou full. Full est plus sûr.
            updateDashboard();
        }

        function calculateAndRenderCharts() {
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            
            const container = document.getElementById('charts-container');
            container.innerHTML = '';

            let totalGlobalLoad = 0;
            let totalGlobalCapacity = 0;

            valueStreams.forEach((vs, vsIndex) => {
                const loads = [0, 0, 0, 0];
                const capacities = [vs.capacityPerPI, vs.capacityPerPI, vs.capacityPerPI, vs.capacityPerPI];

                epics.forEach(epic => {
                    // Ignorer les Epics non planifiées ("Backlog")
                    if(epic.startPI !== "Backlog") {
                        const piIndex = epic.startPI - 1;
                        if (piIndex >= 0 && piIndex < 4) {
                            const percentage = epic[`vs${vsIndex + 1}`]; 
                            const load = epic.estimate * (percentage / 100);
                            loads[piIndex] += load;
                        }
                    }
                });

                totalGlobalLoad += loads.reduce((a, b) => a + b, 0);
                totalGlobalCapacity += (vs.capacityPerPI * 4);

                const canvasContainer = document.createElement('div');
                canvasContainer.className = "h-64 w-full relative border-b pb-4";
                const canvas = document.createElement('canvas');
                canvas.id = `chart-vs-${vsIndex}`;
                canvasContainer.appendChild(canvas);
                container.appendChild(canvasContainer);

                const ctx = canvas.getContext('2d');
                const barColors = loads.map(load => 
                    load > vs.capacityPerPI ? 'rgba(239, 68, 68, 0.8)' : vs.color
                );

                const newChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['PI 1', 'PI 2', 'PI 3', 'PI 4'],
                        datasets: [
                            {
                                label: 'Charge Planifiée (J/H)',
                                data: loads,
                                backgroundColor: barColors,
                                borderColor: barColors.map(c => c.replace('0.7', '1')),
                                borderWidth: 1,
                                order: 1
                            },
                            {
                                label: 'Capacité Max',
                                data: capacities,
                                type: 'line',
                                borderColor: '#374151',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointStyle: 'rectRot',
                                pointRadius: 5,
                                order: 0,
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${vs.name}`,
                                align: 'start',
                                font: { size: 16, weight: 'bold' },
                                padding: { bottom: 10 }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end'
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        if(context.dataset.type === 'bar') {
                                            const capacity = vs.capacityPerPI;
                                            const load = context.raw;
                                            const ratio = capacity > 0 ? Math.round((load/capacity)*100) : 0;
                                            return `Utilisation: ${ratio}%`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Jours/Homme' },
                                suggestedMax: vs.capacityPerPI * 1.2
                            }
                        }
                    }
                });

                chartInstances.push(newChart);
            });

            let ratio = totalGlobalCapacity > 0 ? Math.round((totalGlobalLoad/totalGlobalCapacity)*100) : 0;
            const kpiElem = document.getElementById('avgCompletion');
            kpiElem.innerText = `${ratio}%`;
            kpiElem.className = `text-2xl font-bold ${ratio > 100 ? 'text-red-600' : 'text-amber-600'}`;
        }

        function resetData() {
            if(confirm("Réinitialiser toutes les données ?")) {
                epics = generateEpics();
                valueStreams = JSON.parse(JSON.stringify(initialValueStreams));
                document.getElementById('global-status').innerText = "Données Réinitialisées";
                document.getElementById('global-status').className = "bg-slate-700 text-white px-3 py-1 rounded";
                updateDashboard();
            }
        }

        // Init
        window.onload = updateDashboard;

    </script>
</body>
</html>
